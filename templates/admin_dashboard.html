
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --primary-glow: #00f6ff;
            --active-glow: #00ff8c;
            --inactive-glow: #ff4d4d;
            --background-color: #010409;
            --card-bg: rgba(10, 25, 47, 0.7);
            --border-color: rgba(0, 246, 255, 0.2);
            --text-color: #e6edf3;
            --secondary-text: rgba(230, 237, 243, 0.7);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3;
        }
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            background: rgba(5, 15, 30, 0.6);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--border-color);
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 2;
            overflow-y: auto;
        }
        .sidebar-header h2 { font-family: 'Orbitron', sans-serif; margin: 0 0 40px 0; font-size: 1.8rem; color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow); text-align: center;}
        
        .control-panel h3 {
            font-family: 'Orbitron', sans-serif; font-size: 1.2rem; margin: 0 0 20px 0;
            color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px;
        }
        .status-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .status-item span { font-weight: 600; font-size: 0.9rem; }
        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status-active { background-color: rgba(0, 255, 140, 0.1); color: var(--active-glow); border: 1px solid rgba(0, 255, 140, 0.2); }
        .status-inactive { background-color: rgba(255, 77, 77, 0.1); color: var(--inactive-glow); border: 1px solid rgba(255, 77, 77, 0.2); }
        .toggle-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .toggle-btn svg { transition: color 0.3s ease; }
        .toggle-btn:hover svg { color: #fff !important; }

        .main-content {
            flex-grow: 1;
            padding: 40px 50px;
            overflow-y: auto;
        }
        .main-content::-webkit-scrollbar { width: 6px; }
        .main-content::-webkit-scrollbar-thumb { background-color: var(--primary-glow); border-radius: 3px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .header h1 { font-family: 'Orbitron', sans-serif; margin: 0; font-size: 2.8rem; color: #fff; }
        .header .logout-btn { color: var(--primary-glow); text-decoration: none; font-weight: 600; border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 8px; transition: all 0.3s ease; }
        .header .logout-btn:hover { background-color: rgba(0, 246, 255, 0.1); box-shadow: 0 0 15px var(--primary-glow); }

        .proctoring-grid {
    display: grid;
    /* You can change 250px to any size you like */
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}
        
        .student-feed {
            background: var(--card-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 12px;
            padding: 15px;
        }
        /* Updated to style the new img tag */
        .student-feed img { 
            width: 100%; 
            border-radius: 8px; 
            background-color: #000; 
        }
        .student-feed h3 { margin: 10px 0 5px 0; font-family: 'Orbitron', sans-serif; }
        .student-feed p { margin: 0; color: var(--secondary-text); font-size: 0.9rem; }
        .no-students-message {
            grid-column: 1 / -1; text-align: center; font-size: 1.2rem;
            color: var(--secondary-text); padding: 50px;
        }

        .subjects-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px;
        }
        .subject-card {
            background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 30px; text-decoration: none; color: var(--text-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease; text-align: center;
        }
        .subject-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0, 246, 255, 0.1); }
        .card-icon { width: 60px; height: 60px; margin: 0 auto 20px auto; color: var(--primary-glow); }
        .subject-card h3 { font-family: 'Orbitron', sans-serif; margin: 0 0 25px 0; font-size: 1.3rem; }
        .card-actions { display: flex; gap: 10px; justify-content: center; }
        .card-actions .btn {
             flex-grow: 1; padding: 10px 15px; background: rgba(0, 246, 255, 0.1);
             color: var(--text-color); border: 1px solid var(--border-color);
             border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
             transition: all 0.3s ease; text-decoration: none;
        }
        .card-actions .btn:hover { background: var(--primary-glow); color: var(--background-color); }
        .card-actions .btn.results { background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3); }
        .card-actions .btn.results:hover { background: #ffc107; color: var(--background-color); }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Admin Console</h2>
        </div>
        <div class="control-panel">
            <h3>Exam Control Center</h3>
            {% for code, status in exam_status.items() %}
            <div class="status-item">
                <span>{{ code.upper() }}</span>
                <span class="status-pill status-{{ status }}">{{ status }}</span>
                <form action="/admin/toggle_exam/{{ code }}" method="POST" style="display: inline;">
                    <button type="submit" class="toggle-btn" title="Toggle Status">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                             style="color: {% if status == 'active' %}var(--active-glow){% else %}var(--inactive-glow){% endif %};">
                            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                            <path d="M12 8v8"></path>
                        </svg>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    </aside>
    
    <main class="main-content">
        <div class="header">
            <h1>Command Center</h1>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">Logout</a>
        </div>
        
        <h2>Live Proctoring</h2>
        <div id="proctoring-grid" class="proctoring-grid">
             <p class="no-students-message">Waiting for students to start their exams...</p>
        </div>

        <h2 style="margin-top: 40px;">Subject Management</h2>
        <div class="subjects-grid">
            <div class="subject-card">
                <div class="card-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg></div>
                <h3>Theoretical Computer Science</h3>
                <div class="card-actions"><a href="{{ url_for('admin_questions', subject='tcs') }}" class="btn">Manage Qs</a><a href="{{ url_for('admin_results', subject='tcs') }}" class="btn results">Results</a></div>
            </div>
            <div class="subject-card">
                <div class="card-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A11.953 11.953 0 0112 16.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0-3.866-2.134-7.16-5.157-8.843" /></svg></div>
                <h3>Internet Programming</h3>
                <div class="card-actions"><a href="{{ url_for('admin_questions', subject='ip') }}" class="btn">Manage Qs</a><a href="{{ url_for('admin_results', subject='ip') }}" class="btn results">Results</a></div>
            </div>
            <div class="subject-card">
                <div class="card-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg></div>
                <h3>Data Warehouse & Mining</h3>
                <div class="card-actions"><a href="{{ url_for('admin_questions', subject='dwm') }}" class="btn">Manage Qs</a><a href="{{ url_for('admin_results', subject='dwm') }}" class="btn results">Results</a></div>
            </div>
             <div class="subject-card">
                <div class="card-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.043A5.25 5.25 0 017.5 15h9a5.25 5.25 0 01-.788.043m-8.424 0a5.25 5.25 0 00-1.06 4.135m10.544 0a5.25 5.25 0 01-1.06-4.135m0 0c0-2.896 2.354-5.25 5.25-5.25s5.25 2.354 5.25 5.25m0 0c0 2.896-2.354 5.25-5.25 5.25m0 0c-2.896 0-5.25-2.354-5.25-5.25m-10.5 0c0 2.896 2.354 5.25 5.25 5.25s5.25-2.354 5.25-5.25m0 0c0-2.896-2.354-5.25-5.25-5.25S2.25 12.104 2.25 15" /></svg></div>
                <h3>Computer Networks</h3>
                <div class="card-actions"><a href="{{ url_for('admin_questions', subject='cn') }}" class="btn">Manage Qs</a><a href="{{ url_for('admin_results', subject='cn') }}" class="btn results">Results</a></div>
            </div>
             <div class="subject-card">
                <div class="card-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg></div>
                <h3>Software Engineering</h3>
                <div class="card-actions"><a href="{{ url_for('admin_questions', subject='se') }}" class="btn">Manage Qs</a><a href="{{ url_for('admin_results', subject='se') }}" class="btn results">Results</a></div>
            </div>
        </div>
    </main>

    <script>
    const socket = io();
    const grid = document.getElementById('proctoring-grid');

    // This is the complete function with the live timer AND all action buttons
    function createStudentFeed(roll_no, info) {
        if (!info || document.getElementById(`feed-${roll_no}`)) return;

        const noStudentsMessage = grid.querySelector('.no-students-message');
        if (noStudentsMessage) noStudentsMessage.remove();

        const feedDiv = document.createElement('div');
        feedDiv.className = 'student-feed';
        feedDiv.id = `feed-${roll_no}`;
        
        const img = document.createElement('img');
        img.id = `img-${roll_no}`;
        img.alt = `Live feed ${roll_no}`;
        
        const name = document.createElement('h3');
        name.textContent = info.name;

        // Div for status text (Roll No, Subject) and the live timer
        const statusDiv = document.createElement('div');
        statusDiv.style.display = 'flex';
        statusDiv.style.justifyContent = 'space-between';
        statusDiv.style.alignItems = 'center';
        statusDiv.style.marginBottom = '5px';
        statusDiv.innerHTML = `
            <p style="margin: 0;">Roll No: ${roll_no} | Subject: ${info.subject.toUpperCase()}</p>
            <p id="timer-${roll_no}" class="student-timer" data-start-time="${info.startTime}" style="margin: 0; font-weight: bold;">
                <span style="color: #00ff8c;">ðŸŸ¢</span> 00:00
            </p>
        `;
        
        // Div for the action buttons (Warn, Terminate)
        const actionsDiv = document.createElement('div');
        actionsDiv.style.marginTop = '10px';
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '5px';
        actionsDiv.innerHTML = `
            <button class="btn-action warn" data-roll-no="${roll_no}" data-msg="Warning: Please ensure your face is well-lit.">ðŸ’¡ Low Light</button>
            <button class="btn-action warn" data-roll-no="${roll_no}" data-msg="Warning: Please ensure you are alone in the room.">ðŸ‘¤ Person Detected</button>
            <button class="btn-action terminate" data-roll-no="${roll_no}" style="background-color: #900C3F; color: white; border-color: #FF5733;">Terminate</button>
        `;

        feedDiv.appendChild(img);
        feedDiv.appendChild(name);
        feedDiv.appendChild(statusDiv);
        feedDiv.appendChild(actionsDiv);
        grid.appendChild(feedDiv);
    }

    // Function to update all timers every second
    function updateAllTimers() {
        document.querySelectorAll('.student-timer').forEach(timerEl => {
            const startTime = parseFloat(timerEl.dataset.startTime);
            if (isNaN(startTime)) return;

            const elapsedSeconds = Math.floor((Date.now() / 1000) - startTime);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Only update if the student is not marked as disconnected
            if (!timerEl.textContent.includes("Disconnected")) {
                 timerEl.innerHTML = `<span style="color: #00ff8c;">ðŸŸ¢</span> ${formattedTime}`;
            }
        });
    }

    // Start the global timer updater
    setInterval(updateAllTimers, 1000);

    // --- SOCKET.IO EVENT LISTENERS ---

    socket.on('connect', () => {
        socket.emit('admin_join');
    });

    socket.on('active_students_list', (students) => {
        grid.innerHTML = '<p class="no-students-message">Waiting for students to start their exams...</p>';
        for (const roll_no in students) {
            createStudentFeed(roll_no, students[roll_no]);
        }
    });

    socket.on('student_started_exam', (data) => {
        createStudentFeed(data.roll_no, data.info);
    });

    socket.on('student_left_exam', (data) => {
        const timerEl = document.getElementById(`timer-${data.roll_no}`);
        if (timerEl) {
            timerEl.innerHTML = `<span style="color: #ff4d4d;">ðŸ”´</span> Disconnected`;
        }
        const imgEl = document.getElementById(`img-${data.roll_no}`);
        if (imgEl) {
            imgEl.style.filter = 'grayscale(100%)';
        }
    });

    socket.on('video_frame', (data) => {
        const img = document.getElementById(`img-${data.roll_no}`);
        if (img) {
            img.src = data.frame;
        }
    });

    // This single listener handles clicks for ALL buttons
    grid.addEventListener('click', function(event) {
        const target = event.target;

        // Handle Warning Clicks
        if (target.classList.contains('warn')) {
            const rollNo = target.dataset.rollNo;
            const message = target.dataset.msg;
            socket.emit('send_warning', { 'student_roll_no': rollNo, 'message': message });
        }

        // Handle Terminate Clicks
        if (target.classList.contains('terminate')) {
            const rollNo = target.dataset.rollNo;
            if (confirm(`Are you sure you want to terminate the exam for Roll No: ${rollNo}?`)) {
                socket.emit('terminate_exam', { 'student_roll_no': rollNo });
                target.disabled = true;
                target.textContent = 'Terminated';
            }
        }
    });// In admin.html, inside the <script> tag

socket.on('proctoring_alert', function(data) {
    const feed = document.getElementById(`feed-${data.roll_no}`);
    if (feed) {
        // Add a glowing red border to highlight the student
        feed.style.border = '3px solid #ff4d4d';
        feed.style.boxShadow = '0 0 20px #ff4d4d';

        // Check if an alert message element already exists, if not, create one
        let alertMsg = document.getElementById(`alert-${data.roll_no}`);
        if (!alertMsg) {
            alertMsg = document.createElement('p');
            alertMsg.id = `alert-${data.roll_no}`;
            alertMsg.style.color = '#ff4d4d';
            alertMsg.style.fontWeight = 'bold';
            alertMsg.style.textAlign = 'center';
            // Add the alert message after the action buttons
            const actionsDiv = feed.querySelector('.student-actions');
            if (actionsDiv) {
                actionsDiv.insertAdjacentElement('afterend', alertMsg);
            } else {
                feed.appendChild(alertMsg);
            }
        }
        // Update the alert text
        alertMsg.textContent = `ðŸš¨ AI ALERT: ${data.alert}!`;
    }
});
</script>
</body>
</html>